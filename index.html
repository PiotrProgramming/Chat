<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Client Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .message-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .chat-input {
            max-height: 120px;
        }
        .message-bubble {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-container {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        /* Fix for input text visibility */
        input, textarea {
            color: #1f2937 !important; /* Gray 900 */
        }
        input::placeholder {
            color: #6b7280 !important; /* Gray 500 */
            opacity: 1;
        }
        .message-status {
            font-size: 0.65rem;
            margin-top: 2px;
            text-align: right;
            color: #6b7280;
        }
        .typing-indicator {
            display: none;
            padding: 12px;
            background-color: #f3f4f6;
            border-radius: 12px;
            margin: 8px 0;
            width: fit-content;
            max-width: 70%;
        }
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            margin-right: 4px;
        }
        .offline-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9CA3AF;
            border-radius: 50%;
            margin-right: 4px;
        }
        .handle-tag {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .delete-warning {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
        }
        .search-user-card {
            transition: all 0.2s ease;
        }
        .search-user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .invitation-card {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }
        .message-options {
            position: absolute;
            top: 0;
            right: 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 10;
            min-width: 150px;
        }
        .message-options.show {
            display: block;
        }
        .message-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }
        .message-option:hover {
            background: #f1f5f9;
        }
        .message-option svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        .message-bubble {
            position: relative;
        }
        .message-actions {
            position: absolute;
            top: 4px;
            right: -28px;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .message-bubble:hover .message-actions {
            opacity: 1;
        }
        .delivered-icon {
            color: #6b7280;
            font-size: 0.65rem;
        }
        .read-icon {
            color: #3b82f6;
            font-size: 0.65rem;
        }
        .edit-message-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }
        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Secure communication for professionals</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Sign in to your account</h2>
                    
                    <div id="login-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Invalid username or password
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="username" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="username-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Enter your password">
                            <div id="password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Sign In
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            Don't have an account? <a href="#" id="register-link" class="text-indigo-600 hover:text-indigo-500 font-medium">Create one</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Secure authentication powered by Firebase</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m-6-3v3m-6-3v3m9 8v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6M12 15h.01M12 12h.01M12 9h.01"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Create your professional account</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Create Account</h2>
                    
                    <div id="register-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Error creating account
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="email-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-handle" class="block text-sm font-medium text-gray-700 mb-1">Handle</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input type="text" id="register-handle" class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="yourhandle">
                            </div>
                            <div id="handle-error" class="error-message">Handle must be 3-15 characters, letters and numbers only</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="register-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Create a password">
                            <div id="register-password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <div class="relative">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="confirm-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Confirm your password">
                            <div id="confirm-password-error" class="error-message">Passwords must match</div>
                        </div>
                        
                        <button id="register-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Create Account
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            <a href="#" id="back-to-login" class="text-indigo-600 hover:text-indigo-500 font-medium">Back to Login</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Your account is securely managed by Firebase Authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Account Settings</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Account Information</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-700"><strong>Email:</strong> <span id="settings-email">Loading...</span></p>
                        <p class="text-gray-700 mt-1"><strong>Handle:</strong> <span id="settings-handle">@loading</span></p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Danger Zone</h3>
                    <div class="delete-warning">
                        <p class="text-red-700 font-medium">Delete Account</p>
                        <p class="text-red-600 mt-1">Permanently remove your account and all your data. This action cannot be undone.</p>
                    </div>
                    <button id="delete-account-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Delete Account
                    </button>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-settings" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm Account Deletion</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Deleting your account will permanently remove:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Your profile information</li>
                        <li>All your conversations</li>
                        <li>Your handle from the system</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to permanently delete your account?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-delete" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Contact Confirmation Modal -->
    <div id="remove-contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Remove Contact</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Removing this contact will:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Delete the conversation history</li>
                        <li>Remove the contact from your list</li>
                        <li>Remove you from their contact list</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to remove <strong id="remove-contact-name">@handle</strong>?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-remove" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-remove" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Remove Contact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Message Confirmation Modal -->
    <div id="delete-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Delete Message</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Deleting this message will:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Remove the message from your conversation</li>
                        <li>Also remove it for the other person</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to delete this message?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-delete-message" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-delete-message" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Delete Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Page -->
    <div id="add-contact-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Find Users</h2>
                <p class="text-gray-500 mt-1">Search for users by their handle</p>
            </div>
            
            <div class="p-6">
                <div class="relative mb-6">
                    <input type="text" id="search-handle" placeholder="Search by handle..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                
                <div id="search-results" class="space-y-3">
                    <!-- Search results will appear here -->
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-add-contact" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Invitations Page -->
    <div id="invitations-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Contact Requests</h2>
                <p class="text-gray-500 mt-1">Manage your contact invitations</p>
            </div>
            
            <div id="invitations-container" class="p-6">
                <!-- Invitations will appear here -->
                <div class="text-center text-gray-500 py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </div>
                    <h3 class="font-medium text-lg">No pending requests</h3>
                    <p class="text-gray-500 mt-2">You don't have any pending contact requests</p>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-invitations" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Chat App (Hidden Initially) -->
    <div id="chat-app" class="flex h-screen hidden">
        <!-- Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        ClientChat
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time communication platform</p>
                </div>
                <div class="flex space-x-2">
                    <button id="invitations-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </button>
                    <button id="add-contact-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                    <button id="settings-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.927-1.756 3.353 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.927 0 3.353a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.927 1.756-3.353 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.927 0-3.353a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button id="logout-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search" placeholder="Search conversations..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Conversations List -->
            <div id="conversations" class="flex-1 overflow-y-auto">
                <!-- Contacts will be populated here -->
            </div>
            
            <!-- Account Deletion Button -->
            <div class="p-4 border-t border-gray-200">
                <button id="direct-delete-btn" class="w-full bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 rounded-lg transition duration-200">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Account
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div id="chat-header" class="bg-white border-b border-gray-200 p-4 hidden">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                        <span id="contact-initial">C</span>
                    </div>
                    <div class="ml-3">
                        <h2 id="contact-name" class="font-semibold text-gray-800">Contact Name</h2>
                        <p id="contact-status" class="text-sm"><span class="online-dot"></span>Online</p>
                        <p id="contact-handle" class="handle-tag mt-1">@handle</p>
                    </div>
                </div>
                <div class="ml-auto flex space-x-2">
                    <button id="remove-contact-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages" class="flex-1 message-container bg-gray-100 p-4 overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <!-- Messages will be populated here -->
                    <div class="text-center text-gray-500 my-8 text-sm">
                        Select a contact to start chatting
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div id="message-input" class="bg-white border-t border-gray-200 p-4 hidden">
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-end">
                        <textarea id="message" placeholder="Type your message..." 
                                  class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 resize-none chat-input"
                                  rows="1"></textarea>
                        <button id="send-btn" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase with your configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCxb81EnlyI3vpzul7IzmxECfXFxIM6KfU",
            authDomain: "chat-85393.firebaseapp.com",
            projectId: "chat-85393",
            storageBucket: "chat-85393.firebasestorage.app",
            messagingSenderId: "730787695946",
            appId: "1:730787695946:web:278c457a89a75dc2dbc5b3",
            measurementId: "G-K71Z3979SZ"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUser = null;
        let contacts = [];
        let invitations = [];
        let currentContact = null;
        let typingTimeout = null;
        let isTyping = false;
        let onlineStatusRef = null;
        let isOnline = false;
        let messageListeners = [];
        let handleToUidMap = {};
        let userSearchTimeout = null;
        let selectedMessage = null;

        // Initialize Firebase authentication
        function initFirebaseAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // Get user handle
                    database.ref(`users/${user.uid}`).once('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.handle) {
                            currentUser.handle = userData.handle;
                            updateSettingsPage();
                        }
                    });
                    
                    // Set user online status
                    setUserOnlineStatus(true);
                    
                    // Load contacts and invitations
                    loadContacts();
                    loadInvitations();
                    loadHandleMap();
                    showChatApp();
                } else {
                    setUserOnlineStatus(false);
                    currentUser = null;
                    showLoginPage();
                }
            });
        }

        // Set user online status
        function setUserOnlineStatus(status) {
            if (!currentUser) return;
            
            isOnline = status;
            
            const userStatusRef = database.ref(`status/${currentUser.uid}`);
            
            // Create a reference to the current user's status
            onlineStatusRef = database.ref('.info/connected');
            
            onlineStatusRef.on('value', (snapshot) => {
                if (snapshot.val() == false) return;
                
                userStatusRef.onDisconnect()
                    .set({ 
                        state: 'offline', 
                        lastChanged: firebase.database.ServerValue.TIMESTAMP 
                    })
                    .then(() => {
                        userStatusRef.set({ 
                            state: status ? 'online' : 'offline', 
                            lastChanged: firebase.database.ServerValue.TIMESTAMP 
                        });
                    });
            });
        }

        // Load handle to UID mapping
        function loadHandleMap() {
            database.ref('userHandles').once('value', (snapshot) => {
                const handles = snapshot.val() || {};
                handleToUidMap = handles;
            });
            
            // Listen for new handles
            database.ref('userHandles').on('child_added', (snapshot) => {
                handleToUidMap[snapshot.key] = snapshot.val();
            });
            
            database.ref('userHandles').on('child_changed', (snapshot) => {
                handleToUidMap[snapshot.key] = snapshot.val();
            });
            
            database.ref('userHandles').on('child_removed', (snapshot) => {
                delete handleToUidMap[snapshot.key];
            });
        }

        // Load contacts (only those explicitly added)
        function loadContacts() {
            const contactsRef = database.ref(`contacts/${currentUser.uid}`);
            
            contactsRef.once('value', (snapshot) => {
                const contactUids = snapshot.val() || {};
                const uidArray = Object.keys(contactUids);
                
                if (uidArray.length === 0) {
                    contacts = [];
                    updateContactsList();
                    return;
                }
                
                // Get user details for each contact
                const usersRef = database.ref('users');
                usersRef.once('value', (usersSnapshot) => {
                    const users = usersSnapshot.val() || {};
                    contacts = uidArray
                        .filter(uid => users[uid])
                        .map(uid => ({
                            uid,
                            email: users[uid].email,
                            handle: users[uid].handle || uid.substring(0, 8)
                        }));
                    
                    updateContactsList();
                });
            });
            
            // Listen for new contacts
            contactsRef.on('child_added', (snapshot) => {
                const uid = snapshot.key;
                const usersRef = database.ref(`users/${uid}`);
                usersRef.once('value', (userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData) {
                        const newContact = {
                            uid,
                            email: userData.email,
                            handle: userData.handle || uid.substring(0, 8)
                        };
                        
                        // Add to contacts if not already there
                        if (!contacts.some(c => c.uid === uid)) {
                            contacts.push(newContact);
                            updateContactsList();
                        }
                    }
                });
            });
            
            // Listen for removed contacts
            contactsRef.on('child_removed', (snapshot) => {
                const uid = snapshot.key;
                contacts = contacts.filter(c => c.uid !== uid);
                updateContactsList();
            });
        }

        // Load invitations
        function loadInvitations() {
            const invitationsRef = database.ref(`invitations/${currentUser.uid}`);
            
            invitationsRef.on('value', (snapshot) => {
                const invitationUids = snapshot.val() || {};
                const uidArray = Object.keys(invitationUids);
                
                if (uidArray.length === 0) {
                    invitations = [];
                    updateInvitationsList();
                    return;
                }
                
                // Get user details for each invitation
                const usersRef = database.ref('users');
                usersRef.once('value', (usersSnapshot) => {
                    const users = usersSnapshot.val() || {};
                    invitations = uidArray
                        .filter(uid => users[uid])
                        .map(uid => ({
                            uid,
                            email: users[uid].email,
                            handle: users[uid].handle || uid.substring(0, 8)
                        }));
                    
                    updateInvitationsList();
                });
            });
        }

        // Update invitations list UI
        function updateInvitationsList() {
            const invitationsContainer = document.getElementById('invitations-container');
            invitationsContainer.innerHTML = '';
            
            if (invitations.length === 0) {
                invitationsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">No pending requests</h3>
                        <p class="text-gray-500 mt-2">You don't have any pending contact requests</p>
                    </div>
                `;
                return;
            }
            
            invitations.forEach(invitation => {
                const invitationElement = document.createElement('div');
                invitationElement.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-150 invitation-card';
                
                // Get user details
                database.ref(`users/${invitation.uid}`).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    const email = userData ? userData.email : 'user@example.com';
                    
                    invitationElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                <span>${invitation.handle.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="font-medium text-gray-800">${invitation.handle}</h3>
                                <p class="text-sm text-gray-500 truncate">${email}</p>
                                <div class="handle-tag mt-1">@${invitation.handle}</div>
                            </div>
                            <div class="ml-2 space-x-2">
                                <button class="accept-invitation-btn bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded-lg font-medium">Accept</button>
                                <button class="decline-invitation-btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-1.5 rounded-lg font-medium">Decline</button>
                            </div>
                        </div>
                    `;
                    
                    const acceptButton = invitationElement.querySelector('.accept-invitation-btn');
                    acceptButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        acceptInvitation(invitation.uid, invitation.handle);
                    });
                    
                    const declineButton = invitationElement.querySelector('.decline-invitation-btn');
                    declineButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        declineInvitation(invitation.uid);
                    });
                });
                
                invitationElement.addEventListener('click', () => {
                    // Do nothing on click, only handle button clicks
                });
                
                invitationsContainer.appendChild(invitationElement);
            });
        }

        // Update contacts list UI
        function updateContactsList() {
            const contactsContainer = document.getElementById('conversations');
            contactsContainer.innerHTML = '';
            
            if (contacts.length === 0) {
                contactsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium">No contacts yet</h3>
                        <p class="text-sm mt-1">Click the + button to add contacts</p>
                    </div>
                `;
                return;
            }
            
            contacts.forEach(contact => {
                const contactElement = document.createElement('div');
                contactElement.className = `p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition duration-150 ${currentContact === contact.uid ? 'bg-blue-50 border-r-2 border-r-blue-500' : ''}`;
                contactElement.setAttribute('data-contact-uid', contact.uid);
                
                // Get status
                let statusHTML = '<span class="offline-dot"></span>Offline';
                const statusRef = database.ref(`status/${contact.uid}`);
                statusRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status && status.state === 'online') {
                        statusHTML = '<span class="online-dot"></span>Online';
                        if (currentContact === contact.uid) {
                            document.getElementById('contact-status').innerHTML = statusHTML;
                        }
                    } else {
                        statusHTML = '<span class="offline-dot"></span>Offline';
                    }
                    
                    if (contactElement.querySelector('.contact-status')) {
                        contactElement.querySelector('.contact-status').innerHTML = statusHTML;
                    }
                });
                
                // Get last message
                const conversationId = getConversationId(currentUser.uid, contact.uid);
                const messagesRef = database.ref(`conversations/${conversationId}/messages`);
                
                messagesRef.limitToLast(1).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    const lastMessageEl = contactElement.querySelector('.last-message');
                    if (lastMessageEl) {
                        lastMessageEl.textContent = message.text;
                    }
                    
                    const timeEl = contactElement.querySelector('.last-message-time');
                    if (timeEl) {
                        const date = new Date(message.timestamp);
                        timeEl.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                });
                
                contactElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                            <span>${contact.handle.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between">
                                <h3 class="font-medium text-gray-800">${contact.handle}</h3>
                                <span class="text-xs text-gray-500 last-message-time"></span>
                            </div>
                            <p class="text-sm text-gray-600 truncate last-message">Loading...</p>
                            <div class="contact-status">${statusHTML}</div>
                            <div class="handle-tag mt-1">@${contact.handle}</div>
                        </div>
                    </div>
                `;
                
                contactElement.addEventListener('click', () => openConversation(contact));
                contactsContainer.appendChild(contactElement);
            });
        }

        // Get conversation ID (sorted to ensure consistency)
        function getConversationId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        // Open a conversation
        function openConversation(contact) {
            // Remove previous message listeners
            messageListeners.forEach(listener => listener.off('child_added'));
            messageListeners = [];
            
            currentContact = contact.uid;
            
            // Update UI
            document.getElementById('contact-name').textContent = contact.handle;
            document.getElementById('contact-initial').textContent = contact.handle.charAt(0).toUpperCase();
            document.getElementById('contact-handle').textContent = `@${contact.handle}`;
            
            // Show chat elements
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('message-input').classList.remove('hidden');
            
            // Update contacts list
            document.querySelectorAll('#conversations > div').forEach(el => {
                el.classList.remove('bg-blue-50', 'border-r-2', 'border-r-blue-500');
                el.classList.add('hover:bg-gray-50');
            });
            document.querySelector(`[data-contact-uid="${contact.uid}"]`).classList.remove('hover:bg-gray-50');
            document.querySelector(`[data-contact-uid="${contact.uid}"]`).classList.add('bg-blue-50', 'border-r-2', 'border-r-blue-500');
            
            // Load messages
            loadMessages();
            
            // Listen for new messages
            const conversationId = getConversationId(currentUser.uid, contact.uid);
            const messagesRef = database.ref(`conversations/${conversationId}/messages`);
            const messagesListener = messagesRef.limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                message.id = snapshot.key;
                addMessageToUI(message);
            });
            
            messageListeners.push(messagesRef);
            
            // Mark all messages from this contact as read
            const updates = {};
            updates[`conversations/${conversationId}/messagesRead/${currentUser.uid}`] = true;
            database.ref().update(updates);
        }

        // Load messages for a conversation
        function loadMessages() {
            if (!currentContact) return;
            
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            const conversationId = getConversationId(currentUser.uid, currentContact);
            const messagesRef = database.ref(`conversations/${conversationId}/messages`);
            
            messagesRef.orderByChild('timestamp').limitToLast(50).once('value', (snapshot) => {
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    message.id = childSnapshot.key;
                    addMessageToUI(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }).catch(error => {
                console.error("Error loading messages:", error);
                showError('login-error', 'Failed to load messages: ' + error.message);
            });
        }

        // Add message to UI
        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messages');
            
            // Skip if not for current conversation
            if (message.senderId !== currentContact && 
                message.recipientId !== currentContact &&
                message.senderId !== currentUser.uid) {
                return;
            }
            
            // Check if already in UI
            if (document.getElementById(`message-${message.id}`)) {
                return;
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-4 ${message.senderId === currentUser.uid ? 'text-right' : 'text-left'}`;
            messageElement.id = `message-${message.id}`;
            
            // Format timestamp
            const date = new Date(message.timestamp);
            const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Delivery status
            let deliveryStatus = '<span class="delivered-icon"></span>';
            if (message.delivered) {
                deliveryStatus = '<span class="delivered-icon"></span>';
            }
            if (message.read) {
                deliveryStatus = '<span class="read-icon"></span>';
            }
            
            // Only show options for user's own messages
            const optionsHTML = message.senderId === currentUser.uid ? `
                <div class="message-options" id="options-${message.id}">
                    <div class="message-option edit-message" data-message-id="${message.id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Edit
                    </div>
                    <div class="message-option delete-message" data-message-id="${message.id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete
                    </div>
                </div>
            ` : '';
            
            // Add edit input if editing this message
            const editInputHTML = message.senderId === currentUser.uid ? `
                <div class="edit-message-input" id="edit-input-${message.id}">
                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" value="${message.text}" />
                </div>
                <div class="edit-actions" id="edit-actions-${message.id}">
                    <button class="save-edit bg-blue-600 text-white px-2 py-1 rounded">Save</button>
                    <button class="cancel-edit bg-gray-300 px-2 py-1 rounded">Cancel</button>
                </div>
            ` : '';
            
            messageElement.innerHTML = `
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${message.senderId === currentUser.uid ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'} shadow relative">
                    <div class="flex items-center justify-between">
                        <p class="text-sm message-text">${message.text}</p>
                        <div class="message-actions">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"></path>
                            </svg>
                        </div>
                    </div>
                    ${message.edited ? '<span class="edited-indicator text-xs opacity-50 ml-1">(edited)</span>' : ''}
                    <p class="text-xs opacity-75 mt-1 flex justify-between">
                        <span>${timeString}</span>
                        ${message.senderId === currentUser.uid ? 
                            `<span class="delivery-status">${deliveryStatus}</span>` : ''}
                    </p>
                    ${optionsHTML}
                    ${editInputHTML}
                </div>
            `;
            
            // Add context menu for mobile
            messageElement.addEventListener('contextmenu', (e) => {
                if (message.senderId === currentUser.uid) {
                    e.preventDefault();
                    showOptionsForMessage(message.id);
                }
            });
            
            // Add click handler for message actions
            const messageActions = messageElement.querySelector('.message-actions');
            if (messageActions) {
                messageActions.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showOptionsForMessage(message.id);
                });
            }
            
            // Close options when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.message-options') && !e.target.closest('.message-bubble')) {
                    document.querySelectorAll('.message-options').forEach(el => {
                        el.classList.remove('show');
                    });
                }
            });
            
            // Add click handler for delete option
            const deleteOption = messageElement.querySelector('.delete-message');
            if (deleteOption) {
                deleteOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedMessage = message;
                    document.getElementById('delete-message-modal').classList.remove('hidden');
                });
            }
            
            // Add click handler for edit option
            const editOption = messageElement.querySelector('.edit-message');
            if (editOption) {
                editOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedMessage = message;
                    
                    // Show edit input
                    const editInput = document.getElementById(`edit-input-${message.id}`);
                    const editActions = document.getElementById(`edit-actions-${message.id}`);
                    if (editInput && editActions) {
                        editInput.style.display = 'block';
                        editActions.style.display = 'flex';
                        
                        // Hide options
                        document.getElementById(`options-${message.id}`).classList.remove('show');
                    }
                });
            }
            
            // Add click handler for save edit
            const saveEdit = messageElement.querySelector('.save-edit');
            if (saveEdit) {
                saveEdit.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editMessage();
                });
            }
            
            // Add click handler for cancel edit
            const cancelEdit = messageElement.querySelector('.cancel-edit');
            if (cancelEdit) {
                cancelEdit.addEventListener('click', (e) => {
                    e.stopPropagation();
                    cancelEditMessage();
                });
            }
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Set up delivery confirmation listener
            if (message.senderId === currentUser.uid) {
                const conversationId = getConversationId(currentUser.uid, currentContact);
                const deliveryRef = database.ref(`conversations/${conversationId}/messages/${message.id}/delivered`);
                deliveryRef.on('value', (snapshot) => {
                    const delivered = snapshot.val();
                    if (delivered) {
                        const statusElement = messageElement.querySelector('.delivery-status');
                        if (statusElement) {
                            statusElement.innerHTML = '<span class="delivered-icon"></span>';
                        }
                    }
                });
                
                // Set up read confirmation listener
                const readRef = database.ref(`conversations/${conversationId}/messages/${message.id}/read`);
                readRef.on('value', (snapshot) => {
                    const read = snapshot.val();
                    if (read) {
                        const statusElement = messageElement.querySelector('.delivery-status');
                        if (statusElement) {
                            statusElement.innerHTML = '<span class="read-icon"></span>';
                        }
                    }
                });
            }
        }

        // Show options for a specific message
        function showOptionsForMessage(messageId) {
            // Hide all other options
            document.querySelectorAll('.message-options').forEach(el => {
                el.classList.remove('show');
            });
            
            // Show options for this message
            const optionsElement = document.getElementById(`options-${messageId}`);
            if (optionsElement) {
                optionsElement.classList.add('show');
            }
        }

        // Send a message
        function sendMessage() {
            const messageInput = document.getElementById('message');
            const messageText = messageInput.value.trim();
            
            if (messageText && currentContact) {
                const conversationId = getConversationId(currentUser.uid, currentContact);
                const messagesRef = database.ref(`conversations/${conversationId}/messages`);
                
                // Add message to database
                const newMessageRef = messagesRef.push();
                newMessageRef.set({
                    text: messageText,
                    senderId: currentUser.uid,
                    recipientId: currentContact,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    delivered: false,
                    read: false
                }).then(() => {
                    // Mark as delivered
                    newMessageRef.update({
                        delivered: true
                    });
                }).catch(error => {
                    console.error("Error sending message:", error);
                    showError('login-error', 'Failed to send message: ' + error.message);
                });
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // Edit a message
        function editMessage() {
            const messageInput = document.getElementById('message');
            const editInput = document.getElementById(`edit-input-${selectedMessage.id}`);
            const editedText = editInput.querySelector('input').value.trim();
            
            if (editedText && selectedMessage) {
                const conversationId = getConversationId(currentUser.uid, currentContact);
                const messageRef = database.ref(`conversations/${conversationId}/messages/${selectedMessage.id}`);
                
                messageRef.update({
                    text: editedText,
                    edited: true
                }).then(() => {
                    // Hide edit UI
                    editInput.style.display = 'none';
                    document.getElementById(`edit-actions-${selectedMessage.id}`).style.display = 'none';
                    
                    // Update the message bubble
                    const messageElement = document.getElementById(`message-${selectedMessage.id}`);
                    if (messageElement) {
                        const messageText = messageElement.querySelector('.message-text');
                        if (messageText) {
                            messageText.textContent = editedText;
                        }
                        
                        // Show edited indicator
                        let editedIndicator = messageElement.querySelector('.edited-indicator');
                        if (!editedIndicator) {
                            editedIndicator = document.createElement('span');
                            editedIndicator.className = 'edited-indicator text-xs opacity-50 ml-1';
                            messageElement.querySelector('.message-text').parentNode.appendChild(editedIndicator);
                        }
                        editedIndicator.textContent = '(edited)';
                    }
                    
                    // Clear selected message
                    selectedMessage = null;
                }).catch(error => {
                    console.error("Error editing message:", error);
                    showError('login-error', `Failed to edit message: ${error.message}`);
                });
            }
        }

        // Cancel editing a message
        function cancelEditMessage() {
            if (!selectedMessage) return;
            
            const editInput = document.getElementById(`edit-input-${selectedMessage.id}`);
            const editActions = document.getElementById(`edit-actions-${selectedMessage.id}`);
            
            if (editInput && editActions) {
                editInput.style.display = 'none';
                editActions.style.display = 'none';
            }
            
            selectedMessage = null;
        }

        // Delete a message
        function deleteMessage() {
            if (!selectedMessage) return;
            
            const conversationId = getConversationId(currentUser.uid, currentContact);
            const messageRef = database.ref(`conversations/${conversationId}/messages/${selectedMessage.id}`);
            
            messageRef.remove()
                .then(() => {
                    // Hide modal
                    document.getElementById('delete-message-modal').classList.add('hidden');
                    
                    // Remove from UI
                    const messageElement = document.getElementById(`message-${selectedMessage.id}`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                    
                    // Clear selected message
                    selectedMessage = null;
                })
                .catch(error => {
                    console.error("Error deleting message:", error);
                    showError('login-error', `Failed to delete message: ${error.message}`);
                });
        }

        // Search for users by handle
        function searchByHandle() {
            const searchInput = document.getElementById('search-handle');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                showSearchResults([
                    { message: "Enter at least 2 characters to search", disabled: true }
                ]);
                return;
            }
            
            // Filter handles
            const results = [];
            for (const handle in handleToUidMap) {
                if (handle.toLowerCase().includes(searchTerm)) {
                    results.push({
                        handle: handle,
                        uid: handleToUidMap[handle]
                    });
                }
            }
            
            // If no results found
            if (results.length === 0) {
                showSearchResults([
                    { message: "No users found with that handle", disabled: true }
                ]);
                return;
            }
            
            // Display results
            showSearchResults(results);
        }

        // Show search results
        function showSearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0 || (results[0].disabled && results[0].message.includes("Enter at least"))) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                `;
                return;
            }
            
            if (results[0].disabled) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 01-5.656 0L3 15l1.172-1.172a4 4 0 015.656 0L12 16l2.828-2.828a4 4 0 015.656 0L21 15l-1.172 1.172a4 4 0 01-5.656 0L12 13.172l-2.828 2.828z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 7.172A4 4 0 015.656 6L5 5l.172-1.172a4 4 0 015.656 0L12 6l2.828-2.828a4 4 0 015.656 0L21 5l-1.172 1.172a4 4 0 01-5.656 0L12 4.172l-2.828 2.828z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">No results found</h3>
                        <p class="text-gray-500 mt-2">${results[0].message}</p>
                    </div>
                `;
                return;
            }
            
            results.forEach(result => {
                if (result.uid === currentUser.uid) return; // Skip current user
                
                // Check if already a contact
                const isContact = contacts.some(c => c.uid === result.uid);
                
                // Check if already sent an invitation
                const isInvitationSent = invitations.some(i => i.uid === result.uid);
                
                const resultElement = document.createElement('div');
                resultElement.className = `p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-150 search-user-card ${isContact || isInvitationSent ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
                
                // Get user details
                database.ref(`users/${result.uid}`).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    const email = userData ? userData.email : 'user@example.com';
                    
                    resultElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                <span>${result.handle.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="font-medium text-gray-800">${result.handle}</h3>
                                <p class="text-sm text-gray-500 truncate">${email}</p>
                                <div class="handle-tag mt-1">@${result.handle}</div>
                            </div>
                            ${isContact ? 
                                `<span class="ml-2 bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm">Contact</span>` : 
                                isInvitationSent ?
                                    `<span class="ml-2 bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-sm">Pending</span>` :
                                    `<button class="ml-2 add-contact-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-medium">Invite</button>`}
                        </div>
                    `;
                    
                    if (!isContact && !isInvitationSent) {
                        const addButton = resultElement.querySelector('.add-contact-btn');
                        addButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            sendInvitation(result.uid, result.handle);
                        });
                    }
                });
                
                resultElement.addEventListener('click', () => {
                    if (!isContact && !isInvitationSent) {
                        sendInvitation(result.uid, result.handle);
                    }
                });
                
                resultsContainer.appendChild(resultElement);
            });
        }

        // Send invitation to a user
        function sendInvitation(uid, handle) {
            // Check if already a contact
            if (contacts.some(c => c.uid === uid)) {
                showError('login-error', 'This user is already in your contacts');
                return;
            }
            
            // Check if invitation already sent
            if (invitations.some(i => i.uid === uid)) {
                showError('login-error', 'You have already sent an invitation to this user');
                return;
            }
            
            // Send invitation
            const invitationRef = database.ref(`invitations/${uid}/${currentUser.uid}`);
            invitationRef.set(true)
                .then(() => {
                    showError('login-error', `Invitation sent to @${handle}!`);
                    
                    // Close add contact modal
                    document.getElementById('add-contact-page').classList.add('hidden');
                    document.getElementById('chat-app').classList.remove('hidden');
                })
                .catch(error => {
                    console.error("Error sending invitation:", error);
                    showError('login-error', `Failed to send invitation: ${error.message}`);
                });
        }

        // Accept invitation
        function acceptInvitation(uid, handle) {
            // Create update paths
            const updates = {};
            updates[`contacts/${currentUser.uid}/${uid}`] = true;
            updates[`contacts/${uid}/${currentUser.uid}`] = true;
            updates[`invitations/${currentUser.uid}/${uid}`] = null;
            
            // Update database
            database.ref().update(updates)
            .then(() => {
                showError('login-error', `You're now connected with @${handle}!`);
                
                // Refresh invitations list
                loadInvitations();
                
                // Refresh contacts list
                loadContacts();
            })
            .catch(error => {
                console.error("Error accepting invitation:", error);
                showError('login-error', `Failed to accept invitation: ${error.message}`);
            });
        }

        // Decline invitation
        function declineInvitation(uid) {
            // Create update paths
            const updates = {};
            updates[`invitations/${currentUser.uid}/${uid}`] = null;
            
            // Update database
            database.ref().update(updates)
                .then(() => {
                    // Refresh invitations list
                    loadInvitations();
                })
                .catch(error => {
                    console.error("Error declining invitation:", error);
                });
        }

        // Remove contact
        function removeContact() {
            if (!currentContact) return;
            
            // Find contact info
            const contact = contacts.find(c => c.uid === currentContact);
            if (!contact) return;
            
            // Update modal with contact name
            document.getElementById('remove-contact-name').textContent = `@${contact.handle}`;
            
            // Show confirmation modal
            document.getElementById('remove-contact-modal').classList.remove('hidden');
        }

        // Confirm contact removal
        function confirmRemoveContact() {
            if (!currentContact) return;
            
            // Hide modal
            document.getElementById('remove-contact-modal').classList.add('hidden');
            
            // Create update paths
            const updates = {};
            updates[`contacts/${currentUser.uid}/${currentContact}`] = null;
            updates[`contacts/${currentContact}/${currentUser.uid}`] = null;
            
            // Delete conversation
            const conversationId = getConversationId(currentUser.uid, currentContact);
            updates[`conversations/${conversationId}`] = null;
            
            // Update database
            database.ref().update(updates)
            .then(() => {
                // Reset current contact
                currentContact = null;
                
                // Hide chat header and input
                document.getElementById('chat-header').classList.add('hidden');
                document.getElementById('message-input').classList.add('hidden');
                
                // Update contacts list
                updateContactsList();
                
                // Show success message
                showError('login-error', 'Contact removed successfully!');
            })
            .catch(error => {
                console.error("Error removing contact:", error);
                showError('login-error', `Failed to remove contact: ${error.message}`);
            });
        }

        // Add a contact
        function addContact(uid, handle) {
            // This function is no longer used directly
            // We now use the invitation system
        }

        // Update settings page with current user info
        function updateSettingsPage() {
            if (!currentUser || !currentUser.handle) return;
            
            document.getElementById('settings-email').textContent = currentUser.email;
            document.getElementById('settings-handle').textContent = `@${currentUser.handle}`;
        }

        // Delete account function
        function deleteAccount() {
            if (!currentUser) return;
            
            // Show confirmation modal
            document.getElementById('delete-confirmation-modal').classList.remove('hidden');
        }

        // Confirm account deletion
        function confirmAccountDeletion() {
            if (!currentUser) return;
            
            // Hide modal
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            
            // Show loading state
            const deleteButton = document.getElementById('delete-account-btn');
            const directDeleteButton = document.getElementById('direct-delete-btn');
            const originalText = deleteButton.innerHTML;
            deleteButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Deleting...
            `;
            directDeleteButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-red-700 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Deleting...
            `;
            deleteButton.disabled = true;
            directDeleteButton.disabled = true;
            
            // Delete user data from database
            const userRef = database.ref(`users/${currentUser.uid}`);
            const handleRef = database.ref(`userHandles/${currentUser.handle}`);
            const statusRef = database.ref(`status/${currentUser.uid}`);
            const contactsRef = database.ref(`contacts/${currentUser.uid}`);
            const contactOfRef = database.ref(`contactOf/${currentUser.uid}`);
            const invitationsRef = database.ref(`invitations/${currentUser.uid}`);
            
            // First, remove the user from all conversations
            database.ref('conversations').once('value', (snapshot) => {
                const conversations = snapshot.val() || {};
                
                // Find all conversations involving this user
                const updates = {};
                for (const conversationId in conversations) {
                    if (conversations[conversationId].participants && 
                        conversations[conversationId].participants[currentUser.uid]) {
                        // Remove user from participants
                        updates[`conversations/${conversationId}/participants/${currentUser.uid}`] = null;
                        
                        // If this was a 1:1 conversation, delete the entire conversation
                        const participantCount = Object.keys(conversations[conversationId].participants || {}).length;
                        if (participantCount <= 2) { // Only this user and one other
                            updates[`conversations/${conversationId}`] = null;
                        }
                    }
                }
                
                // Apply updates to conversations
                database.ref().update(updates)
                    .then(() => {
                        // Now delete all user-specific data
                        return Promise.all([
                            userRef.remove(),
                            handleRef.remove(),
                            statusRef.remove(),
                            contactsRef.remove(),
                            contactOfRef.remove(),
                            invitationsRef.remove()
                        ]);
                    })
                    .then(() => {
                        // Finally, delete the Firebase Authentication account
                        return auth.currentUser.delete();
                    })
                    .then(() => {
                        // Clear currentUser
                        currentUser = null;
                        
                        // Show success message
                        showError('login-error', 'Your account has been successfully deleted');
                    })
                    .catch(error => {
                        console.error("Error deleting account:", error);
                        
                        // Restore button state
                        deleteButton.innerHTML = originalText;
                        directDeleteButton.innerHTML = 'Delete Account';
                        deleteButton.disabled = false;
                        directDeleteButton.disabled = false;
                        
                        // Show error message
                        showError('login-error', `Failed to delete account: ${error.message}`);
                    });
            });
        }

        // Initialize the chat app
        function initChatApp() {
            // Set up event listeners
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            document.getElementById('message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('message').addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
                
                // Show typing indicator
                if (!isTyping && currentContact) {
                    isTyping = true;
                    const conversationId = getConversationId(currentUser.uid, currentContact);
                    database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).set(true);
                    
                    if (typingTimeout) clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        isTyping = false;
                        database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).remove();
                    }, 3000);
                }
            });
            
            // Search functionality
            document.getElementById('search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#conversations > div').forEach(el => {
                    const contactName = el.querySelector('h3').textContent.toLowerCase();
                    
                    if (contactName.includes(searchTerm)) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                });
            });
            
            // Add contact button
            document.getElementById('add-contact-btn').addEventListener('click', () => {
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('add-contact-page').classList.remove('hidden');
                
                // Clear search results
                document.getElementById('search-handle').value = '';
                document.getElementById('search-results').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                `;
            });
            
            // Invitations button
            document.getElementById('invitations-btn').addEventListener('click', () => {
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('invitations-page').classList.remove('hidden');
                
                // Load invitations
                loadInvitations();
            });
            
            // Settings button
            document.getElementById('settings-btn').addEventListener('click', () => {
                updateSettingsPage();
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('settings-page').classList.remove('hidden');
            });
            
            // Direct delete button
            document.getElementById('direct-delete-btn').addEventListener('click', deleteAccount);
            
            // Delete account button
            document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);
            
            // Cancel delete
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.getElementById('delete-confirmation-modal').classList.add('hidden');
            });
            
            // Confirm delete
            document.getElementById('confirm-delete').addEventListener('click', confirmAccountDeletion);
            
            // Cancel remove contact
            document.getElementById('cancel-remove').addEventListener('click', () => {
                document.getElementById('remove-contact-modal').classList.add('hidden');
            });
            
            // Confirm remove contact
            document.getElementById('confirm-remove').addEventListener('click', confirmRemoveContact);
            
            // Cancel delete message
            document.getElementById('cancel-delete-message').addEventListener('click', () => {
                document.getElementById('delete-message-modal').classList.add('hidden');
            });
            
            // Confirm delete message
            document.getElementById('confirm-delete-message').addEventListener('click', deleteMessage);
            
            // Close settings
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Close add contact modal
            document.getElementById('close-add-contact').addEventListener('click', () => {
                document.getElementById('add-contact-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Close invitations modal
            document.getElementById('close-invitations').addEventListener('click', () => {
                document.getElementById('invitations-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Remove contact button
            document.getElementById('remove-contact-btn').addEventListener('click', removeContact);
            
            // Search handle input
            document.getElementById('search-handle').addEventListener('input', (e) => {
                searchByHandle();
            });
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', () => {
                setUserOnlineStatus(false);
                auth.signOut();
            });
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
        }

        // Show register page
        function showRegisterPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
        }

        // Show chat app
        function showChatApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
            initChatApp();
        }

        // Validate login form
        function validateLoginForm() {
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('username').classList.remove('input-error');
            document.getElementById('password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('login-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('username').classList.add('input-error');
                document.getElementById('username-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('password').classList.add('input-error');
                document.getElementById('password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Validate registration form
        function validateRegistrationForm() {
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('register-email').classList.remove('input-error');
            document.getElementById('register-handle').classList.remove('input-error');
            document.getElementById('register-password').classList.remove('input-error');
            document.getElementById('confirm-password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('register-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('register-email').classList.add('input-error');
                document.getElementById('email-error').style.display = 'block';
                isValid = false;
            }
            
            // Handle validation
            const handleRegex = /^[a-zA-Z0-9]{3,15}$/;
            if (!handleRegex.test(handle)) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('register-password').classList.add('input-error');
                document.getElementById('register-password-error').style.display = 'block';
                isValid = false;
            }
            
            // Confirm password validation
            if (password !== confirmPassword) {
                document.getElementById('confirm-password').classList.add('input-error');
                document.getElementById('confirm-password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Handle login
        function handleLogin() {
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login error:", error);
                    showError('login-error', error.message);
                });
        }

        // Handle registration
        function handleRegistration() {
            if (!validateRegistrationForm()) {
                return;
            }
            
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            
            // Check if handle is available
            if (handleToUidMap[handle]) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').textContent = 'Handle is already taken';
                document.getElementById('handle-error').style.display = 'block';
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save user to database
                    const user = userCredential.user;
                    const userData = {
                        email: user.email,
                        handle: handle
                    };
                    
                    // Save user data
                    database.ref('users/' + user.uid).set(userData)
                        .then(() => {
                            // Save handle to UID mapping
                            return database.ref('userHandles/' + handle).set(user.uid);
                        })
                        .catch(error => {
                            console.error("Error saving user ", error);
                            showError('register-error', 'Account created but failed to save user  ' + error.message);
                        });
                })
                .catch(error => {
                    console.error("Registration error:", error);
                    showError('register-error', error.message);
                });
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            initFirebaseAuth();
            
            // Set up event listeners
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-link').addEventListener('click', (e) => {
                e.preventDefault();
                showRegisterPage();
            });
            document.getElementById('back-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginPage();
            });
            document.getElementById('register-btn').addEventListener('click', handleRegistration);
            
            // Username validation
            document.getElementById('username').addEventListener('blur', validateLoginForm);
            document.getElementById('password').addEventListener('blur', validateLoginForm);
            
            // Registration validation
            document.getElementById('register-email').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-handle').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-password').addEventListener('blur', validateRegistrationForm);
            document.getElementById('confirm-password').addEventListener('blur', validateRegistrationForm);
        });
    </script>
</body>
</html>
