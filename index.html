<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Client Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .message-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .chat-input {
            max-height: 120px;
        }
        .message-bubble {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-container {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        /* Fix for input text visibility */
        input, textarea {
            color: #1f2937 !important; /* Gray 900 */
        }
        input::placeholder {
            color: #6b7280 !important; /* Gray 500 */
            opacity: 1;
        }
        .message-status {
            font-size: 0.65rem;
            margin-top: 2px;
            text-align: right;
            color: #6b7280;
        }
        .typing-indicator {
            display: none;
            padding: 12px;
            background-color: #f3f4f6;
            border-radius: 12px;
            margin: 8px 0;
            width: fit-content;
            max-width: 70%;
        }
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            margin-right: 4px;
        }
        .offline-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9CA3AF;
            border-radius: 50%;
            margin-right: 4px;
        }
        .handle-tag {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .delete-warning {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
        }
        .search-user-card {
            transition: all 0.2s ease;
        }
        .search-user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .invitation-card {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }
        .message-options {
            position: absolute;
            top: 0;
            right: 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 10;
            min-width: 150px;
        }
        .message-options.show {
            display: block;
        }
        .message-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }
        .message-option:hover {
            background: #f1f5f9;
        }
        .message-option svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        .message-bubble {
            position: relative;
        }
        .message-actions {
            position: absolute;
            top: 4px;
            right: -28px;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .message-bubble:hover .message-actions {
            opacity: 1;
        }
        .delivered-icon {
            color: #6b7280;
            font-size: 0.65rem;
        }
        .read-icon {
            color: #3b82f6;
            font-size: 0.65rem;
        }
        .edit-message-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }
        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Secure communication for professionals</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Sign in to your account</h2>
                    
                    <div id="login-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Invalid username or password
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="username" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="username-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Enter your password">
                            <div id="password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Sign In
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            Don't have an account? <a href="#" id="register-link" class="text-indigo-600 hover:text-indigo-500 font-medium">Create one</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Secure authentication powered by Firebase</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m-6-3v3m-6-3v3m9 8v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6M12 15h.01M12 12h.01M12 9h.01"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Create your professional account</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Create Account</h2>
                    
                    <div id="register-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Error creating account
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="email-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-handle" class="block text-sm font-medium text-gray-700 mb-1">Handle</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input type="text" id="register-handle" class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="yourhandle">
                            </div>
                            <div id="handle-error" class="error-message">Handle must be 3-15 characters, letters and numbers only</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="register-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Create a password">
                            <div id="register-password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <div class="relative">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="confirm-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Confirm your password">
                            <div id="confirm-password-error" class="error-message">Passwords must match</div>
                        </div>
                        
                        <button id="register-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Create Account
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            <a href="#" id="back-to-login" class="text-indigo-600 hover:text-indigo-500 font-medium">Back to Login</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Your account is securely managed by Firebase Authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Account Settings</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Account Information</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-700"><strong>Email:</strong> <span id="settings-email">Loading...</span></p>
                        <p class="text-gray-700 mt-1"><strong>Handle:</strong> <span id="settings-handle">@loading</span></p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Danger Zone</h3>
                    <div class="delete-warning">
                        <p class="text-red-700 font-medium">Delete Account</p>
                        <p class="text-red-600 mt-1">Permanently remove your account and all your data. This action cannot be undone.</p>
                    </div>
                    <button id="delete-account-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Delete Account
                    </button>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-settings" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm Account Deletion</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Deleting your account will permanently remove:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Your profile information</li>
                        <li>All your conversations</li>
                        <li>Your handle from the system</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to permanently delete your account?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-delete" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Contact Confirmation Modal -->
    <div id="remove-contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Remove Contact</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Removing this contact will:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Delete the conversation history</li>
                        <li>Remove the contact from your list</li>
                        <li>Remove you from their contact list</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to remove <strong id="remove-contact-name">@handle</strong>?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-remove" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-remove" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Remove Contact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Message Confirmation Modal -->
    <div id="delete-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Delete Message</h2>
                
                <div class="delete-warning mb-6">
                    <p class="text-red-700 font-medium">This action cannot be undone!</p>
                    <p class="text-red-600 mt-1">Deleting this message will:</p>
                    <ul class="list-disc list-inside mt-2 text-red-600">
                        <li>Remove the message from your conversation</li>
                        <li>Also remove it for the other person</li>
                    </ul>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to delete this message?
                </p>
                
                <div class="flex space-x-3">
                    <button id="cancel-delete-message" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-delete-message" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                        Yes, Delete Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Page -->
    <div id="add-contact-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Find Users</h2>
                <p class="text-gray-500 mt-1">Search for users by their handle</p>
            </div>
            
            <div class="p-6">
                <div class="relative mb-6">
                    <input type="text" id="search-handle" placeholder="Search by handle..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                
                <div id="search-results" class="space-y-3">
                    <!-- Search results will appear here -->
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-add-contact" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Invitations Page -->
    <div id="invitations-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Contact Requests</h2>
                <p class="text-gray-500 mt-1">Manage your contact invitations</p>
            </div>
            
            <div id="invitations-container" class="p-6">
                <!-- Invitations will appear here -->
                <div class="text-center text-gray-500 py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </div>
                    <h3 class="font-medium text-lg">No pending requests</h3>
                    <p class="text-gray-500 mt-2">You don't have any pending contact requests</p>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-invitations" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Chat App (Hidden Initially) -->
    <div id="chat-app" class="flex h-screen hidden">
        <!-- Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        ClientChat
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time communication platform</p>
                </div>
                <div class="flex space-x-2">
                    <button id="invitations-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </button>
                    <button id="add-contact-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        }).catch(error => {
                            console.error("Error sending message:", error);
                            showError('login-error', 'Failed to send message: ' + error.message);
                        });
                        
                        // Clear input
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                    }
                }
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // Edit a message
        function editMessage() {
            const messageInput = document.getElementById('message');
            const editInput = document.getElementById(`edit-input-${selectedMessage.id}`);
            const editedText = editInput.value.trim();
            
            if (editedText && selectedMessage) {
                const conversationId = getConversationId(currentUser.uid, currentContact);
                const messageRef = database.ref(`conversations/${conversationId}/messages/${selectedMessage.id}`);
                
                messageRef.update({
                    text: editedText,
                    edited: true
                }).then(() => {
                    // Hide edit UI
                    editInput.style.display = 'none';
                    document.getElementById(`edit-actions-${selectedMessage.id}`).style.display = 'none';
                    
                    // Update the message bubble
                    const messageElement = document.getElementById(`message-${selectedMessage.id}`);
                    if (messageElement) {
                        const messageText = messageElement.querySelector('.message-text');
                        if (messageText) {
                            messageText.textContent = editedText;
                            messageText.style.fontStyle = 'italic';
                        }
                        
                        const editedIndicator = messageElement.querySelector('.edited-indicator');
                        if (editedIndicator) {
                            editedIndicator.style.display = 'inline';
                        } else {
                            const indicator = document.createElement('span');
                            indicator.className = 'edited-indicator text-xs opacity-50 ml-1';
                            indicator.textContent = '(edited)';
                            messageText.parentNode.appendChild(indicator);
                        }
                    }
                    
                    // Clear selected message
                    selectedMessage = null;
                }).catch(error => {
                    console.error("Error editing message:", error);
                    showError('login-error', `Failed to edit message: ${error.message}`);
                });
            }
        }

        // Cancel editing a message
        function cancelEdit() {
            const editInput = document.getElementById(`edit-input-${selectedMessage.id}`);
            const editActions = document.getElementById(`edit-actions-${selectedMessage.id}`);
            
            editInput.style.display = 'none';
            editActions.style.display = 'none';
            
            selectedMessage = null;
        }

        // Search for users by handle
        function searchByHandle() {
            const searchInput = document.getElementById('search-handle');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                showSearchResults([
                    { message: "Enter at least 2 characters to search", disabled: true }
                ]);
                return;
            }
            
            // Filter handles
            const results = [];
            for (const handle in handleToUidMap) {
                if (handle.toLowerCase().includes(searchTerm)) {
                    results.push({
                        handle: handle,
                        uid: handleToUidMap[handle]
                    });
                }
            }
            
            // If no results found
            if (results.length === 0) {
                showSearchResults([
                    { message: "No users found with that handle", disabled: true }
                ]);
                return;
            }
            
            // Display results
            showSearchResults(results);
        }

        // Show search results
        function showSearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0 || (results[0].disabled && results[0].message.includes("Enter at least"))) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                `;
                return;
            }
            
            if (results[0].disabled) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 01-5.656 0L3 15l1.172-1.172a4 4 0 015.656 0L12 16l2.828-2.828a4 4 0 015.656 0L21 15l-1.172 1.172a4 4 0 01-5.656 0L12 13.172l-2.828 2.828z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 7.172A4 4 0 015.656 6L5 5l.172-1.172a4 4 0 015.656 0L12 6l2.828-2.828a4 4 0 015.656 0L21 5l-1.172 1.172a4 4 0 01-5.656 0L12 4.172l-2.828 2.828z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">No results found</h3>
                        <p class="text-gray-500 mt-2">${results[0].message}</p>
                    </div>
                `;
                return;
            }
            
            results.forEach(result => {
                if (result.uid === currentUser.uid) return; // Skip current user
                
                // Check if already a contact
                const isContact = contacts.some(c => c.uid === result.uid);
                
                // Check if already sent an invitation
                const isInvitationSent = invitations.some(i => i.uid === result.uid);
                
                const resultElement = document.createElement('div');
                resultElement.className = `p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-150 search-user-card ${isContact || isInvitationSent ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
                
                // Get user details
                database.ref(`users/${result.uid}`).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    const email = userData ? userData.email : 'user@example.com';
                    
                    resultElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                <span>${result.handle.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="font-medium text-gray-800">${result.handle}</h3>
                                <p class="text-sm text-gray-500 truncate">${email}</p>
                                <div class="handle-tag mt-1">@${result.handle}</div>
                            </div>
                            ${isContact ? 
                                `<span class="ml-2 bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm">Contact</span>` : 
                                isInvitationSent ?
                                    `<span class="ml-2 bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-sm">Pending</span>` :
                                    `<button class="ml-2 add-contact-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-medium">Invite</button>`}
                        </div>
                    `;
                    
                    if (!isContact && !isInvitationSent) {
                        const addButton = resultElement.querySelector('.add-contact-btn');
                        addButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            sendInvitation(result.uid, result.handle);
                        });
                    }
                });
                
                resultElement.addEventListener('click', () => {
                    if (!isContact && !isInvitationSent) {
                        sendInvitation(result.uid, result.handle);
                    }
                });
                
                resultsContainer.appendChild(resultElement);
            });
        }

        // Send invitation to a user
        function sendInvitation(uid, handle) {
            // Check if already a contact
            if (contacts.some(c => c.uid === uid)) {
                showError('login-error', 'This user is already in your contacts');
                return;
            }
            
            // Check if invitation already sent
            if (invitations.some(i => i.uid === uid)) {
                showError('login-error', 'You have already sent an invitation to this user');
                return;
            }
            
            // Send invitation
            const invitationRef = database.ref(`invitations/${uid}/${currentUser.uid}`);
            invitationRef.set(true)
                .then(() => {
                    showError('login-error', `Invitation sent to @${handle}!`);
                    
                    // Close add contact modal
                    document.getElementById('add-contact-page').classList.add('hidden');
                    document.getElementById('chat-app').classList.remove('hidden');
                })
                .catch(error => {
                    console.error("Error sending invitation:", error);
                    showError('login-error', `Failed to send invitation: ${error.message}`);
                });
        }

        // Accept invitation
        function acceptInvitation(uid, handle) {
            // Create update paths
            const updates = {};
            updates[`contacts/${currentUser.uid}/${uid}`] = true;
            updates[`contacts/${uid}/${currentUser.uid}`] = true;
            updates[`invitations/${currentUser.uid}/${uid}`] = null;
            
            // Update database
            database.ref().update(updates)
            .then(() => {
                showError('login-error', `You're now connected with @${handle}!`);
                
                // Refresh invitations list
                loadInvitations();
                
                // Refresh contacts list
                loadContacts();
            })
            .catch(error => {
                console.error("Error accepting invitation:", error);
                showError('login-error', `Failed to accept invitation: ${error.message}`);
            });
        }

        // Decline invitation
        function declineInvitation(uid) {
            // Create update paths
            const updates = {};
            updates[`invitations/${currentUser.uid}/${uid}`] = null;
            
            // Update database
            database.ref().update(updates)
                .then(() => {
                    // Refresh invitations list
                    loadInvitations();
                })
                .catch(error => {
                    console.error("Error declining invitation:", error);
                });
        }

        // Remove contact
        function removeContact() {
            if (!currentContact) return;
            
            // Find contact info
            const contact = contacts.find(c => c.uid === currentContact);
            if (!contact) return;
            
            // Update modal with contact name
            document.getElementById('remove-contact-name').textContent = `@${contact.handle}`;
            
            // Show confirmation modal
            document.getElementById('remove-contact-modal').classList.remove('hidden');
        }

        // Confirm contact removal
        function confirmRemoveContact() {
            if (!currentContact) return;
            
            // Hide modal
            document.getElementById('remove-contact-modal').classList.add('hidden');
            
            // Create update paths
            const updates = {};
            updates[`contacts/${currentUser.uid}/${currentContact}`] = null;
            updates[`contacts/${currentContact}/${currentUser.uid}`] = null;
            
            // Delete conversation
            const conversationId = getConversationId(currentUser.uid, currentContact);
            updates[`conversations/${conversationId}`] = null;
            
            // Update database
            database.ref().update(updates)
            .then(() => {
                // Reset current contact
                currentContact = null;
                
                // Hide chat header and input
                document.getElementById('chat-header').classList.add('hidden');
                document.getElementById('message-input').classList.add('hidden');
                
                // Update contacts list
                updateContactsList();
                
                // Show success message
                showError('login-error', 'Contact removed successfully!');
            })
            .catch(error => {
                console.error("Error removing contact:", error);
                showError('login-error', `Failed to remove contact: ${error.message}`);
            });
        }

        // Add a contact
        function addContact(uid, handle) {
            // This function is no longer used directly
            // We now use the invitation system
        }

        // Update settings page with current user info
        function updateSettingsPage() {
            if (!currentUser || !currentUser.handle) return;
            
            document.getElementById('settings-email').textContent = currentUser.email;
            document.getElementById('settings-handle').textContent = `@${currentUser.handle}`;
        }

        // Delete account function
        function deleteAccount() {
            if (!currentUser) return;
            
            // Show confirmation modal
            document.getElementById('delete-confirmation-modal').classList.remove('hidden');
        }

        // Confirm account deletion
        function confirmAccountDeletion() {
            if (!currentUser) return;
            
            // Hide modal
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            
            // Show loading state
            const deleteButton = document.getElementById('delete-account-btn');
            const directDeleteButton = document.getElementById('direct-delete-btn');
            const originalText = deleteButton.innerHTML;
            deleteButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Deleting...
            `;
            directDeleteButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-red-700 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Deleting...
            `;
            deleteButton.disabled = true;
            directDeleteButton.disabled = true;
            
            // Delete user data from database
            const userRef = database.ref(`users/${currentUser.uid}`);
            const handleRef = database.ref(`userHandles/${currentUser.handle}`);
            const statusRef = database.ref(`status/${currentUser.uid}`);
            const contactsRef = database.ref(`contacts/${currentUser.uid}`);
            const contactOfRef = database.ref(`contactOf/${currentUser.uid}`);
            const invitationsRef = database.ref(`invitations/${currentUser.uid}`);
            
            // First, remove the user from all conversations
            database.ref('conversations').once('value', (snapshot) => {
                const conversations = snapshot.val() || {};
                
                // Find all conversations involving this user
                const updates = {};
                for (const conversationId in conversations) {
                    if (conversations[conversationId].participants && 
                        conversations[conversationId].participants[currentUser.uid]) {
                        // Remove user from participants
                        updates[`conversations/${conversationId}/participants/${currentUser.uid}`] = null;
                        
                        // If this was a 1:1 conversation, delete the entire conversation
                        const participantCount = Object.keys(conversations[conversationId].participants || {}).length;
                        if (participantCount <= 2) { // Only this user and one other
                            updates[`conversations/${conversationId}`] = null;
                        }
                    }
                }
                
                // Apply updates to conversations
                database.ref().update(updates)
                    .then(() => {
                        // Now delete all user-specific data
                        return Promise.all([
                            userRef.remove(),
                            handleRef.remove(),
                            statusRef.remove(),
                            contactsRef.remove(),
                            contactOfRef.remove(),
                            invitationsRef.remove()
                        ]);
                    })
                    .then(() => {
                        // Finally, delete the Firebase Authentication account
                        return auth.currentUser.delete();
                    })
                    .then(() => {
                        // Clear currentUser
                        currentUser = null;
                        
                        // Show success message
                        showError('login-error', 'Your account has been successfully deleted');
                    })
                    .catch(error => {
                        console.error("Error deleting account:", error);
                        
                        // Restore button state
                        deleteButton.innerHTML = originalText;
                        directDeleteButton.innerHTML = 'Delete Account';
                        deleteButton.disabled = false;
                        directDeleteButton.disabled = false;
                        
                        // Show error message
                        showError('login-error', `Failed to delete account: ${error.message}`);
                    });
            });
        }

        // Initialize the chat app
        function initChatApp() {
            // Set up event listeners
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            document.getElementById('message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('message').addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
                
                // Show typing indicator
                if (!isTyping && currentContact) {
                    isTyping = true;
                    const conversationId = getConversationId(currentUser.uid, currentContact);
                    database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).set(true);
                    
                    if (typingTimeout) clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        isTyping = false;
                        database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).remove();
                    }, 3000);
                }
            });
            
            // Search functionality
            document.getElementById('search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#conversations > div').forEach(el => {
                    const contactName = el.querySelector('h3').textContent.toLowerCase();
                    
                    if (contactName.includes(searchTerm)) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                });
            });
            
            // Add contact button
            document.getElementById('add-contact-btn').addEventListener('click', () => {
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('add-contact-page').classList.remove('hidden');
                
                // Clear search results
                document.getElementById('search-handle').value = '';
                document.getElementById('search-results').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="font-medium text-lg">Find people by handle</h3>
                        <p class="text-gray-500 mt-2">Enter a handle above to search for users</p>
                    </div>
                `;
            });
            
            // Invitations button
            document.getElementById('invitations-btn').addEventListener('click', () => {
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('invitations-page').classList.remove('hidden');
                
                // Load invitations
                loadInvitations();
            });
            
            // Settings button
            document.getElementById('settings-btn').addEventListener('click', () => {
                updateSettingsPage();
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('settings-page').classList.remove('hidden');
            });
            
            // Direct delete button
            document.getElementById('direct-delete-btn').addEventListener('click', deleteAccount);
            
            // Delete account button
            document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);
            
            // Cancel delete
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.getElementById('delete-confirmation-modal').classList.add('hidden');
            });
            
            // Confirm delete
            document.getElementById('confirm-delete').addEventListener('click', confirmAccountDeletion);
            
            // Cancel remove contact
            document.getElementById('cancel-remove').addEventListener('click', () => {
                document.getElementById('remove-contact-modal').classList.add('hidden');
            });
            
            // Confirm remove contact
            document.getElementById('confirm-remove').addEventListener('click', confirmRemoveContact);
            
            // Cancel delete message
            document.getElementById('cancel-delete-message').addEventListener('click', () => {
                document.getElementById('delete-message-modal').classList.add('hidden');
            });
            
            // Confirm delete message
            document.getElementById('confirm-delete-message').addEventListener('click', deleteMessage);
            
            // Close settings
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Close add contact modal
            document.getElementById('close-add-contact').addEventListener('click', () => {
                document.getElementById('add-contact-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Close invitations modal
            document.getElementById('close-invitations').addEventListener('click', () => {
                document.getElementById('invitations-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Remove contact button
            document.getElementById('remove-contact-btn').addEventListener('click', removeContact);
            
            // Search handle input
            document.getElementById('search-handle').addEventListener('input', (e) => {
                searchByHandle();
            });
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', () => {
                setUserOnlineStatus(false);
                auth.signOut();
            });
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
        }

        // Show register page
        function showRegisterPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
        }

        // Show chat app
        function showChatApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('invitations-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
            document.getElementById('remove-contact-modal').classList.add('hidden');
            document.getElementById('delete-message-modal').classList.add('hidden');
            initChatApp();
        }

        // Validate login form
        function validateLoginForm() {
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('username').classList.remove('input-error');
            document.getElementById('password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('login-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('username').classList.add('input-error');
                document.getElementById('username-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('password').classList.add('input-error');
                document.getElementById('password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Validate registration form
        function validateRegistrationForm() {
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('register-email').classList.remove('input-error');
            document.getElementById('register-handle').classList.remove('input-error');
            document.getElementById('register-password').classList.remove('input-error');
            document.getElementById('confirm-password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('register-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('register-email').classList.add('input-error');
                document.getElementById('email-error').style.display = 'block';
                isValid = false;
            }
            
            // Handle validation
            const handleRegex = /^[a-zA-Z0-9]{3,15}$/;
            if (!handleRegex.test(handle)) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('register-password').classList.add('input-error');
                document.getElementById('register-password-error').style.display = 'block';
                isValid = false;
            }
            
            // Confirm password validation
            if (password !== confirmPassword) {
                document.getElementById('confirm-password').classList.add('input-error');
                document.getElementById('confirm-password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Handle login
        function handleLogin() {
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login error:", error);
                    showError('login-error', error.message);
                });
        }

        // Handle registration
        function handleRegistration() {
            if (!validateRegistrationForm()) {
                return;
            }
            
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            
            // Check if handle is available
            if (handleToUidMap[handle]) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').textContent = 'Handle is already taken';
                document.getElementById('handle-error').style.display = 'block';
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save user to database
                    const user = userCredential.user;
                    const userData = {
                        email: user.email,
                        handle: handle
                    };
                    
                    // Save user data
                    database.ref('users/' + user.uid).set(userData)
                        .then(() => {
                            // Save handle to UID mapping
                            return database.ref('userHandles/' + handle).set(user.uid);
                        })
                        .catch(error => {
                            console.error("Error saving user ", error);
                            showError('register-error', 'Account created but failed to save user  ' + error.message);
                        });
                })
                .catch(error => {
                    console.error("Registration error:", error);
                    showError('register-error', error.message);
                });
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            initFirebaseAuth();
            
            // Set up event listeners
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-link').addEventListener('click', (e) => {
                e.preventDefault();
                showRegisterPage();
            });
            document.getElementById('back-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginPage();
            });
            document.getElementById('register-btn').addEventListener('click', handleRegistration);
            
            // Username validation
            document.getElementById('username').addEventListener('blur', validateLoginForm);
            document.getElementById('password').addEventListener('blur', validateLoginForm);
            
            // Registration validation
            document.getElementById('register-email').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-handle').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-password').addEventListener('blur', validateRegistrationForm);
            document.getElementById('confirm-password').addEventListener('blur', validateRegistrationForm);
        });
    </script>
</body>
</html>
