<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Client Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .message-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .chat-input {
            max-height: 120px;
        }
        .message-bubble {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-container {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        /* Fix for input text visibility */
        input, textarea {
            color: #1f2937 !important; /* Gray 900 */
        }
        input::placeholder {
            color: #6b7280 !important; /* Gray 500 */
            opacity: 1;
        }
        .message-status {
            font-size: 0.65rem;
            margin-top: 2px;
            text-align: right;
            color: #6b7280;
        }
        .typing-indicator {
            display: none;
            padding: 12px;
            background-color: #f3f4f6;
            border-radius: 12px;
            margin: 8px 0;
            width: fit-content;
            max-width: 70%;
        }
        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            margin-right: 4px;
        }
        .offline-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9CA3AF;
            border-radius: 50%;
            margin-right: 4px;
        }
        .handle-tag {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Secure communication for professionals</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Sign in to your account</h2>
                    
                    <div id="login-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Invalid username or password
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="username" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="username-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Enter your password">
                            <div id="password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Sign In
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            Don't have an account? <a href="#" id="register-link" class="text-indigo-600 hover:text-indigo-500 font-medium">Create one</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Secure authentication powered by Firebase</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="login-container p-8 text-white">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m-6-3v3m-6-3v3m9 8v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6M12 15h.01M12 12h.01M12 9h.01"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">ClientChat Pro</h1>
                    <p class="text-indigo-100 mt-2">Create your professional account</p>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Create Account</h2>
                    
                    <div id="register-error" class="bg-red-50 text-red-500 text-sm p-3 rounded-lg mb-4 hidden">
                        Error creating account
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="you@example.com">
                            <div id="email-error" class="error-message">Please enter a valid email</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-handle" class="block text-sm font-medium text-gray-700 mb-1">Handle</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">@</span>
                                <input type="text" id="register-handle" class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="yourhandle">
                            </div>
                            <div id="handle-error" class="error-message">Handle must be 3-15 characters, letters and numbers only</div>
                        </div>
                        
                        <div class="relative">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="register-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Create a password">
                            <div id="register-password-error" class="error-message">Password must be at least 6 characters</div>
                        </div>
                        
                        <div class="relative">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="confirm-password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900" placeholder="Confirm your password">
                            <div id="confirm-password-error" class="error-message">Passwords must match</div>
                        </div>
                        
                        <button id="register-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition duration-200">
                            Create Account
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            <a href="#" id="back-to-login" class="text-indigo-600 hover:text-indigo-500 font-medium">Back to Login</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-indigo-100">
                    <p>Your account is securely managed by Firebase Authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Page -->
    <div id="add-contact-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Add Contact</h2>
                <p class="text-gray-500 mt-1">Find users by their handle</p>
            </div>
            
            <div class="p-6">
                <div class="relative mb-6">
                    <input type="text" id="search-handle" placeholder="Search by handle..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                
                <div id="search-results" class="space-y-3">
                    <!-- Search results will appear here -->
                    <div class="text-center text-gray-500 py-4">
                        Enter a handle to search for users
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200">
                <button id="close-add-contact" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2.5 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Chat App (Hidden Initially) -->
    <div id="chat-app" class="flex h-screen hidden">
        <!-- Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        ClientChat
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time communication platform</p>
                </div>
                <div class="flex space-x-2">
                    <button id="add-contact-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                    <button id="logout-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search" placeholder="Search conversations..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Conversations List -->
            <div id="conversations" class="flex-1 overflow-y-auto">
                <!-- Contacts will be populated here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div id="chat-header" class="bg-white border-b border-gray-200 p-4 hidden">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                        <span id="contact-initial">C</span>
                    </div>
                    <div class="ml-3">
                        <h2 id="contact-name" class="font-semibold text-gray-800">Contact Name</h2>
                        <p id="contact-status" class="text-sm"><span class="online-dot"></span>Online</p>
                        <p id="contact-handle" class="handle-tag mt-1">@handle</p>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages" class="flex-1 message-container bg-gray-100 p-4 overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <!-- Messages will be populated here -->
                    <div class="text-center text-gray-500 my-8 text-sm">
                        Select a contact to start chatting
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div id="message-input" class="bg-white border-t border-gray-200 p-4 hidden">
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-end">
                        <textarea id="message" placeholder="Type your message..." 
                                  class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 resize-none chat-input"
                                  rows="1"></textarea>
                        <button id="send-btn" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase with your configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCxb81EnlyI3vpzul7IzmxECfXFxIM6KfU",
            authDomain: "chat-85393.firebaseapp.com",
            projectId: "chat-85393",
            storageBucket: "chat-85393.firebasestorage.app",
            messagingSenderId: "730787695946",
            appId: "1:730787695946:web:278c457a89a75dc2dbc5b3",
            measurementId: "G-K71Z3979SZ"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUser = null;
        let contacts = [];
        let currentContact = null;
        let typingTimeout = null;
        let isTyping = false;
        let onlineStatusRef = null;
        let isOnline = false;
        let messageListeners = [];
        let handleToUidMap = {};

        // Initialize Firebase authentication
        function initFirebaseAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // Get user handle
                    database.ref(`users/${user.uid}`).once('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.handle) {
                            currentUser.handle = userData.handle;
                        }
                    });
                    
                    // Set user online status
                    setUserOnlineStatus(true);
                    
                    // Load contacts
                    loadContacts();
                    loadHandleMap();
                    showChatApp();
                } else {
                    setUserOnlineStatus(false);
                    currentUser = null;
                    showLoginPage();
                }
            });
        }

        // Set user online status
        function setUserOnlineStatus(status) {
            if (!currentUser) return;
            
            isOnline = status;
            
            const userStatusRef = database.ref(`status/${currentUser.uid}`);
            
            // Create a reference to the current user's status
            onlineStatusRef = database.ref('.info/connected');
            
            onlineStatusRef.on('value', (snapshot) => {
                if (snapshot.val() == false) return;
                
                userStatusRef.onDisconnect()
                    .set({ 
                        state: 'offline', 
                        lastChanged: firebase.database.ServerValue.TIMESTAMP 
                    })
                    .then(() => {
                        userStatusRef.set({ 
                            state: status ? 'online' : 'offline', 
                            lastChanged: firebase.database.ServerValue.TIMESTAMP 
                        });
                    });
            });
        }

        // Load handle to UID mapping
        function loadHandleMap() {
            database.ref('userHandles').once('value', (snapshot) => {
                const handles = snapshot.val() || {};
                handleToUidMap = handles;
            });
            
            // Listen for new handles
            database.ref('userHandles').on('child_added', (snapshot) => {
                handleToUidMap[snapshot.key] = snapshot.val();
            });
            
            database.ref('userHandles').on('child_changed', (snapshot) => {
                handleToUidMap[snapshot.key] = snapshot.val();
            });
            
            database.ref('userHandles').on('child_removed', (snapshot) => {
                delete handleToUidMap[snapshot.key];
            });
        }

        // Load contacts (other users)
        function loadContacts() {
            const usersRef = database.ref('users');
            usersRef.once('value', (snapshot) => {
                const users = snapshot.val() || {};
                contacts = Object.keys(users)
                    .filter(uid => uid !== currentUser.uid)
                    .map(uid => ({
                        uid,
                        email: users[uid].email,
                        handle: users[uid].handle || uid.substring(0, 8)
                    }));
                
                // Update contacts list
                updateContactsList();
            });
            
            // Listen for new users
            usersRef.on('child_added', (snapshot) => {
                const uid = snapshot.key;
                if (uid !== currentUser.uid) {
                    const newUser = {
                        uid,
                        email: snapshot.val().email,
                        handle: snapshot.val().handle || uid.substring(0, 8)
                    };
                    
                    // Add to contacts if not already there
                    if (!contacts.some(c => c.uid === uid)) {
                        contacts.push(newUser);
                        updateContactsList();
                    }
                }
            });
        }

        // Update contacts list UI
        function updateContactsList() {
            const contactsContainer = document.getElementById('conversations');
            contactsContainer.innerHTML = '';
            
            contacts.forEach(contact => {
                const contactElement = document.createElement('div');
                contactElement.className = `p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition duration-150 ${currentContact === contact.uid ? 'bg-blue-50 border-r-2 border-r-blue-500' : ''}`;
                contactElement.setAttribute('data-contact-uid', contact.uid);
                
                // Get status
                let statusHTML = '<span class="offline-dot"></span>Offline';
                const statusRef = database.ref(`status/${contact.uid}`);
                statusRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status && status.state === 'online') {
                        statusHTML = '<span class="online-dot"></span>Online';
                        if (currentContact === contact.uid) {
                            document.getElementById('contact-status').innerHTML = statusHTML;
                        }
                    } else {
                        statusHTML = '<span class="offline-dot"></span>Offline';
                    }
                    
                    if (contactElement.querySelector('.contact-status')) {
                        contactElement.querySelector('.contact-status').innerHTML = statusHTML;
                    }
                });
                
                // Get last message
                const conversationId = getConversationId(currentUser.uid, contact.uid);
                const messagesRef = database.ref(`conversations/${conversationId}/messages`);
                
                messagesRef.limitToLast(1).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    const lastMessageEl = contactElement.querySelector('.last-message');
                    if (lastMessageEl) {
                        lastMessageEl.textContent = message.text;
                    }
                    
                    const timeEl = contactElement.querySelector('.last-message-time');
                    if (timeEl) {
                        const date = new Date(message.timestamp);
                        timeEl.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                });
                
                contactElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                            <span>${contact.handle.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between">
                                <h3 class="font-medium text-gray-800">${contact.handle}</h3>
                                <span class="text-xs text-gray-500 last-message-time"></span>
                            </div>
                            <p class="text-sm text-gray-600 truncate last-message">Loading...</p>
                            <div class="contact-status">${statusHTML}</div>
                            <div class="handle-tag mt-1">@${contact.handle}</div>
                        </div>
                    </div>
                `;
                
                contactElement.addEventListener('click', () => openConversation(contact));
                contactsContainer.appendChild(contactElement);
            });
        }

        // Get conversation ID (sorted to ensure consistency)
        function getConversationId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        // Open a conversation
        function openConversation(contact) {
            // Remove previous message listeners
            messageListeners.forEach(listener => listener.off('child_added'));
            messageListeners = [];
            
            currentContact = contact.uid;
            
            // Update UI
            document.getElementById('contact-name').textContent = contact.handle;
            document.getElementById('contact-initial').textContent = contact.handle.charAt(0).toUpperCase();
            document.getElementById('contact-handle').textContent = `@${contact.handle}`;
            
            // Show chat elements
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('message-input').classList.remove('hidden');
            
            // Update contacts list
            document.querySelectorAll('#conversations > div').forEach(el => {
                el.classList.remove('bg-blue-50', 'border-r-2', 'border-r-blue-500');
                el.classList.add('hover:bg-gray-50');
            });
            document.querySelector(`[data-contact-uid="${contact.uid}"]`).classList.remove('hover:bg-gray-50');
            document.querySelector(`[data-contact-uid="${contact.uid}"]`).classList.add('bg-blue-50', 'border-r-2', 'border-r-blue-500');
            
            // Load messages
            loadMessages();
            
            // Listen for new messages
            const conversationId = getConversationId(currentUser.uid, contact.uid);
            const messagesRef = database.ref(`conversations/${conversationId}/messages`);
            const messagesListener = messagesRef.limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                message.id = snapshot.key;
                addMessageToUI(message);
            });
            
            messageListeners.push(messagesRef);
        }

        // Load messages for a conversation
        function loadMessages() {
            if (!currentContact) return;
            
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            const conversationId = getConversationId(currentUser.uid, currentContact);
            const messagesRef = database.ref(`conversations/${conversationId}/messages`);
            
            messagesRef.orderByChild('timestamp').limitToLast(50).once('value', (snapshot) => {
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    message.id = childSnapshot.key;
                    addMessageToUI(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }).catch(error => {
                console.error("Error loading messages:", error);
                showError('login-error', 'Failed to load messages: ' + error.message);
            });
        }

        // Add message to UI
        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messages');
            
            // Skip if not for current conversation
            if (message.senderId !== currentContact && 
                message.recipientId !== currentContact &&
                message.senderId !== currentUser.uid) {
                return;
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-4 ${message.senderId === currentUser.uid ? 'text-right' : 'text-left'}`;
            
            // Format timestamp
            const date = new Date(message.timestamp);
            const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageElement.innerHTML = `
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${message.senderId === currentUser.uid ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'} shadow">
                    <p class="text-sm">${message.text}</p>
                    <p class="text-xs opacity-75 mt-1 flex justify-between">
                        <span>${timeString}</span>
                        ${message.senderId === currentUser.uid ? 
                            `<span class="message-status">Delivered</span>` : ''}
                    </p>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send a message
        function sendMessage() {
            const messageInput = document.getElementById('message');
            const messageText = messageInput.value.trim();
            
            if (messageText && currentContact) {
                const conversationId = getConversationId(currentUser.uid, currentContact);
                const messagesRef = database.ref(`conversations/${conversationId}/messages`);
                
                // Add message to database
                const newMessageRef = messagesRef.push();
                newMessageRef.set({
                    text: messageText,
                    senderId: currentUser.uid,
                    recipientId: currentContact,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    delivered: true
                }).catch(error => {
                    console.error("Error sending message:", error);
                    showError('login-error', 'Failed to send message: ' + error.message);
                });
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // Search for users by handle
        function searchByHandle() {
            const searchInput = document.getElementById('search-handle');
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                showSearchResults([
                    { message: "Enter at least 2 characters to search", disabled: true }
                ]);
                return;
            }
            
            // Filter handles
            const results = [];
            for (const handle in handleToUidMap) {
                if (handle.toLowerCase().includes(searchTerm)) {
                    results.push({
                        handle: handle,
                        uid: handleToUidMap[handle]
                    });
                }
            }
            
            // If no results found
            if (results.length === 0) {
                showSearchResults([
                    { message: "No users found with that handle", disabled: true }
                ]);
                return;
            }
            
            // Display results
            showSearchResults(results);
        }

        // Show search results
        function showSearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0 || (results[0].disabled && results[0].message.includes("Enter at least"))) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        Enter a handle to search for users
                    </div>
                `;
                return;
            }
            
            if (results[0].disabled) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        ${results[0].message}
                    </div>
                `;
                return;
            }
            
            results.forEach(result => {
                if (result.uid === currentUser.uid) return; // Skip current user
                
                // Check if already a contact
                const isContact = contacts.some(c => c.uid === result.uid);
                
                const resultElement = document.createElement('div');
                resultElement.className = `p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-150 ${isContact ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
                
                // Get user details
                database.ref(`users/${result.uid}`).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    const email = userData ? userData.email : 'user@example.com';
                    
                    resultElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                <span>${result.handle.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-medium text-gray-800">${result.handle}</h3>
                                <p class="text-sm text-gray-500 truncate">${email}</p>
                                <div class="handle-tag mt-1">@${result.handle}</div>
                            </div>
                            ${isContact ? 
                                `<span class="ml-auto bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Added</span>` : 
                                `<button class="ml-auto add-contact-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Add</button>`}
                        </div>
                    `;
                    
                    if (!isContact) {
                        const addButton = resultElement.querySelector('.add-contact-btn');
                        addButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            addContact(result.uid, result.handle);
                        });
                    }
                });
                
                resultElement.addEventListener('click', () => {
                    if (!isContact) {
                        addContact(result.uid, result.handle);
                    }
                });
                
                resultsContainer.appendChild(resultElement);
            });
        }

        // Add a contact
        function addContact(uid, handle) {
            // Check if already a contact
            if (contacts.some(c => c.uid === uid)) {
                showError('login-error', 'This user is already in your contacts');
                return;
            }
            
            // Add to contacts list
            const newContact = {
                uid: uid,
                handle: handle,
                email: 'Loading...'
            };
            
            contacts.push(newContact);
            updateContactsList();
            
            // Show success message
            showError('login-error', `Added @${handle} to your contacts!`);
            
            // Close add contact modal
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
        }

        // Initialize the chat app
        function initChatApp() {
            // Set up event listeners
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            document.getElementById('message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('message').addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
                
                // Show typing indicator
                if (!isTyping && currentContact) {
                    isTyping = true;
                    const conversationId = getConversationId(currentUser.uid, currentContact);
                    database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).set(true);
                    
                    if (typingTimeout) clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        isTyping = false;
                        database.ref(`conversations/${conversationId}/typing/${currentUser.uid}`).remove();
                    }, 3000);
                }
            });
            
            // Search functionality
            document.getElementById('search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#conversations > div').forEach(el => {
                    const contactName = el.querySelector('h3').textContent.toLowerCase();
                    
                    if (contactName.includes(searchTerm)) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                });
            });
            
            // Add contact button
            document.getElementById('add-contact-btn').addEventListener('click', () => {
                document.getElementById('chat-app').classList.add('hidden');
                document.getElementById('add-contact-page').classList.remove('hidden');
                
                // Clear search results
                document.getElementById('search-handle').value = '';
                document.getElementById('search-results').innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        Enter a handle to search for users
                    </div>
                `;
            });
            
            // Close add contact modal
            document.getElementById('close-add-contact').addEventListener('click', () => {
                document.getElementById('add-contact-page').classList.add('hidden');
                document.getElementById('chat-app').classList.remove('hidden');
            });
            
            // Search handle input
            document.getElementById('search-handle').addEventListener('input', (e) => {
                searchByHandle();
            });
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', () => {
                setUserOnlineStatus(false);
                auth.signOut();
            });
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
        }

        // Show register page
        function showRegisterPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('chat-app').classList.add('hidden');
        }

        // Show chat app
        function showChatApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('add-contact-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
            initChatApp();
        }

        // Validate login form
        function validateLoginForm() {
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('username').classList.remove('input-error');
            document.getElementById('password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('login-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('username').classList.add('input-error');
                document.getElementById('username-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('password').classList.add('input-error');
                document.getElementById('password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Validate registration form
        function validateRegistrationForm() {
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            let isValid = true;
            
            // Reset errors
            document.getElementById('register-email').classList.remove('input-error');
            document.getElementById('register-handle').classList.remove('input-error');
            document.getElementById('register-password').classList.remove('input-error');
            document.getElementById('confirm-password').classList.remove('input-error');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('register-error').classList.add('hidden');
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('register-email').classList.add('input-error');
                document.getElementById('email-error').style.display = 'block';
                isValid = false;
            }
            
            // Handle validation
            const handleRegex = /^[a-zA-Z0-9]{3,15}$/;
            if (!handleRegex.test(handle)) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (password.length < 6) {
                document.getElementById('register-password').classList.add('input-error');
                document.getElementById('register-password-error').style.display = 'block';
                isValid = false;
            }
            
            // Confirm password validation
            if (password !== confirmPassword) {
                document.getElementById('confirm-password').classList.add('input-error');
                document.getElementById('confirm-password-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }

        // Handle login
        function handleLogin() {
            if (!validateLoginForm()) {
                return;
            }
            
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login error:", error);
                    showError('login-error', error.message);
                });
        }

        // Handle registration
        function handleRegistration() {
            if (!validateRegistrationForm()) {
                return;
            }
            
            const email = document.getElementById('register-email').value.trim();
            const handle = document.getElementById('register-handle').value.trim();
            const password = document.getElementById('register-password').value;
            
            // Check if handle is available
            if (handleToUidMap[handle]) {
                document.getElementById('register-handle').classList.add('input-error');
                document.getElementById('handle-error').textContent = 'Handle is already taken';
                document.getElementById('handle-error').style.display = 'block';
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save user to database
                    const user = userCredential.user;
                    const userData = {
                        email: user.email,
                        handle: handle
                    };
                    
                    // Save user data
                    database.ref('users/' + user.uid).set(userData)
                        .then(() => {
                            // Save handle to UID mapping
                            return database.ref('userHandles/' + handle).set(user.uid);
                        })
                        .catch(error => {
                            console.error("Error saving user data:", error);
                            showError('register-error', 'Account created but failed to save user data: ' + error.message);
                        });
                })
                .catch(error => {
                    console.error("Registration error:", error);
                    showError('register-error', error.message);
                });
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            initFirebaseAuth();
            
            // Set up event listeners
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-link').addEventListener('click', (e) => {
                e.preventDefault();
                showRegisterPage();
            });
            document.getElementById('back-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginPage();
            });
            document.getElementById('register-btn').addEventListener('click', handleRegistration);
            
            // Username validation
            document.getElementById('username').addEventListener('blur', validateLoginForm);
            document.getElementById('password').addEventListener('blur', validateLoginForm);
            
            // Registration validation
            document.getElementById('register-email').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-handle').addEventListener('blur', validateRegistrationForm);
            document.getElementById('register-password').addEventListener('blur', validateRegistrationForm);
            document.getElementById('confirm-password').addEventListener('blur', validateRegistrationForm);
        });
    </script>
</body>
</html>
